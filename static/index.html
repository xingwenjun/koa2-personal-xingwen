<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title></title>
		<style>
			body{
				background-color: rgba(26, 26, 26, 1);
				padding: 0;
				margin: 0;
				padding-bottom: 300px;
			}
			*{
				box-sizing: border-box;
			}
			#content{
				height: 300px;
				width: 100%;
			}
			.chat-line{
				display: flex;
				margin-top: 23px;
			}
			.avatar{
				width: 40px;
				height: 40px;
				border-radius: 8px;
			}
			.word{
				position: relative;
				max-width: 240px;
				background-color: rgba(45, 45, 45, 1);
				border-radius: 6px;
				padding: 10px 10px;
				font-size: 16px;
				color: #fff;
				margin-left: 10px;
				flex-shrink: 0;
				font-family: "思源黑体";
			}
			.word::after{
				position: absolute;
				content: ' ';
				width: 0;
				height: 0;
				border-top: 6px solid transparent;
				border-right: 6px solid rgba(45, 45, 45, 1);
				border-bottom: 6px solid transparent;
				left: 0px;
				transform: translate(-100%,-50%);
				top: 18px;
			}
			button{
				border: 0;
				width: 100%;
				height: 40px;
				font-size: 16px;
				margin-bottom: 20px;
				background-color: #f7ad4d;
				color: #fff;
				font-weight: bold;
			}
			#touxiang-box{
				position: relative;
				width: 100%;
				height: 40px;
				font-size: 16px;
				margin-bottom: 20px;
				background-color: #f7ad4d;
				color: #fff;
				font-weight: bold;
				text-align: center;
				line-height: 40px;
			}
			#touxiang{
				width: 100%;
				margin-bottom: 20px;
				background-color: #fff;
				position: absolute;
				left: 0;
				top: 0;
				opacity: 0;
			}
			#scroll-box{
				margin-top: 200px;
				height: 400px;
				position: relative;
			}
			#list{
				padding-left: 12px;
				background-color: rgba(26, 26, 26, 1);
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
			}
		</style>
</head>
<body>
	<textarea id="content" placeholder="根据换行分段"></textarea>
	<button id="btn">生成聊天</button>
	<div id="touxiang-box">
		<span>上传头像</span>
		<input type="file" id="touxiang" />
	</div>
	<button id="image">导出图片</button>
	<input id="distance" placeholder="每次滚动距离设置" />
	<input id="time" placeholder="滚动间隔时间，单位毫秒" />
	<button id="scroll">点击滚动</button>
	<div id="scroll-box">
		<div id="list"></div>
	</div>
</body>
<script src="./js/image.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script>
	let touxiang = "./img/tou.png"
document.getElementById("content").value = ``

let distance = document.getElementById("distance")
distance.value = 150
let scroll = distance.value
let flag = false
let height = 0
let dom = document.getElementById("scroll-box")
let sDom = ''
let lh = ''
let ch = ''


document.getElementById("btn").addEventListener("click",function(){
	let text = document.getElementById("content").value
	const arr = text.split('\n\n')
	const dom = document.getElementById('list')
	dom.innerHTML=""
	for(let i=0;arr.length>i;i++) {
		dom.innerHTML+=`<div class="chat-line">
			<img class="avatar" src="${touxiang}" alt="">
			<span class="word">${arr[i]}</span>
		</div>`
	}
	reset()
})
document.getElementById("touxiang").addEventListener("change",function(){
	const f = this.files[0]
	const fr = new FileReader()
	fr.readAsDataURL(f)
	fr.onload = function(e) {
		touxiang = this.result
		document.querySelectorAll(".avatar").src=touxiang
		const list = document.querySelectorAll(".avatar")
		if(list.length>0) {
			list.forEach(item=>{
				item.src=touxiang
			})
		}
	}
})
function reset() {
	dom.style.overflow = "unset"
	sDom.style.top='0px'
	height = 0
	scroll = distance.value
	flag = false
}
document.getElementById("scroll").addEventListener("click", function() {
	if(flag == true) return
	flag = true
	dom = document.getElementById("scroll-box")
	sDom = document.getElementById("list")
	lh = document.getElementById("list").offsetHeight
	ch = dom.clientHeight
	reset()
	scrollAnimation()
})
function scrollAnimation() {
	dom.style.overflow = "hidden"
	document.documentElement.scrollTop = 600
	animation()
}
function animation() {
	if((ch-height) >= (lh-height/2)) {
		flag = false
		return
	}
	if(scroll <= 0) {
		scroll = distance.value
		setTimeout(function(){
			window.requestAnimationFrame(animation)
		},document.getElementById("time").value || 1000)
		return
	}
	sDom.style.top=height+'px'
	height--
	scroll--
	
	window.requestAnimationFrame(animation)
}
function DownLoadDomImg(el) {
	if(!el) return
    html2canvas(el, {
	// 页面高度
	height: el.height,
	// 页面宽度
	width: el.width,
	onrendered: function(canvas) {
		var mA = document.createElement("a");
		mA.href = canvas.toDataURL()
		mA.setAttribute('download', 'download.png');
		mA.click();
　　　　　　　　　// 如果是ie浏览器 则需要 使用ie浏览器的下载方法 进行下载 一会补充
	}
    });
}
document.getElementById("image").onclick=function() {
	html2canvas(document.getElementById("list"),{
		    x: 0, // x坐标
		    y: 0, // y坐标
		    foreignObjectRendering: true, // 是否在浏览器支持的情况下使用ForeignObject渲染
		    useCORS: true, // 是否尝试使用CORS从服务器加载图像
		    async: false, // 是否异步解析和呈现元素
		    // 以下字段必填
		    background: "#ffffff", // 一定要添加背景颜色，否则出来的图片，背景全部都是透明的
		    scale: 2, // 处理模糊问题
		    dpi: 300, // 处理模糊问题
		onrendered:function(canvas){
			const url = canvas.toDataURL("image/png")
			let a = document.createElement('a')
			        a.download = '转化图片.jpg' // 设置下载的文件名，默认是'下载'
			        a.href = url
			        document.body.appendChild(a)
			        a.click()
			        a.remove() // 下载之后把创建的元素删除
		}
	})
}
</script>
</html>
